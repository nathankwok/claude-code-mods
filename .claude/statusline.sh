#!/bin/bash
# Generated by cc-statusline (https://www.npmjs.com/package/@chongdashu/cc-statusline)
# Custom Claude Code statusline - Created: 2025-08-16T18:46:37.647Z
# Theme: detailed | Colors: true | Features: directory, git, model, usage, session, tokens

input=$(cat)

# ---- color helpers (TTY-aware, respect NO_COLOR) ----
use_color=1
[ -t 1 ] || use_color=0
[ -n "$NO_COLOR" ] && use_color=0

C() { if [ "$use_color" -eq 1 ]; then printf '\033[%sm' "$1"; fi; }
RST() { if [ "$use_color" -eq 1 ]; then printf '\033[0m'; fi; }

# ---- basic colors ----
dir_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;36m'; fi; }    # cyan
model_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;35m'; fi; }  # magenta  
version_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;33m'; fi; } # yellow
rst() { if [ "$use_color" -eq 1 ]; then printf '\033[0m'; fi; }

# ---- time helpers ----
to_epoch() {
  ts="$1"
  if command -v gdate >/dev/null 2>&1; then gdate -d "$ts" +%s 2>/dev/null && return; fi
  date -u -j -f "%Y-%m-%dT%H:%M:%S%z" "${ts/Z/+0000}" +%s 2>/dev/null && return
  python3 - "$ts" <<'PY' 2>/dev/null
import sys, datetime
s=sys.argv[1].replace('Z','+00:00')
print(int(datetime.datetime.fromisoformat(s).timestamp()))
PY
}

fmt_time_hm() {
  epoch="$1"
  if date -r 0 +%s >/dev/null 2>&1; then date -r "$epoch" +"%H:%M"; else date -d "@$epoch" +"%H:%M"; fi
}

progress_bar() {
  pct="${1:-0}"; width="${2:-10}"
  [[ "$pct" =~ ^[0-9]+$ ]] || pct=0; ((pct<0))&&pct=0; ((pct>100))&&pct=100
  filled=$(( pct * width / 100 )); empty=$(( width - filled ))
  printf '%*s' "$filled" '' | tr ' ' '='
  printf '%*s' "$empty" '' | tr ' ' '-'
}

# git utilities
num_or_zero() { v="$1"; [[ "$v" =~ ^[0-9]+$ ]] && echo "$v" || echo 0; }

# ---- basics ----
if command -v jq >/dev/null 2>&1; then
  current_dir=$(echo "$input" | jq -r '.workspace.current_dir // .cwd // "unknown"' 2>/dev/null | sed "s|^$HOME|~|g")
  model_name=$(echo "$input" | jq -r '.model.display_name // "Claude"' 2>/dev/null)
  model_version=$(echo "$input" | jq -r '.model.version // ""' 2>/dev/null)
else
  current_dir="unknown"
  model_name="Claude"; model_version=""
fi

# ---- git colors ----
git_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;32m'; fi; }
rst() { if [ "$use_color" -eq 1 ]; then printf '\033[0m'; fi; }

# ---- git ----
git_branch=""
if git rev-parse --git-dir >/dev/null 2>&1; then
  git_branch=$(git branch --show-current 2>/dev/null || git rev-parse --short HEAD 2>/dev/null)
fi

# ---- usage colors ----
usage_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;35m'; fi; }
cost_color() { if [ "$use_color" -eq 1 ]; then printf '\033[1;36m'; fi; }
session_color() { 
  rem_pct=$(( 100 - session_pct ))
  if   (( rem_pct <= 10 )); then SCLR='1;31'
  elif (( rem_pct <= 25 )); then SCLR='1;33'
  else                          SCLR='1;32'; fi
  if [ "$use_color" -eq 1 ]; then printf '\033[%sm' "$SCLR"; fi
}
context_color() { 
  if   (( context_pct >= 85 )); then CCLR='1;31'  # Red for high usage
  elif (( context_pct >= 70 )); then CCLR='1;33'  # Yellow for medium usage
  else                               CCLR='1;32'; fi  # Green for low usage
  if [ "$use_color" -eq 1 ]; then printf '\033[%sm' "$CCLR"; fi
}

# ---- ccusage integration ----
session_txt=""; session_pct=0; session_bar=""
cost_usd=""; cost_per_hour=""; tpm=""; tot_tokens=""
context_txt=""; context_pct=0; context_bar=""

if command -v jq >/dev/null 2>&1; then
  blocks_output=$(npx ccusage@latest blocks --json 2>/dev/null || ccusage blocks --json 2>/dev/null)
  if [ -n "$blocks_output" ]; then
    active_block=$(echo "$blocks_output" | jq -c '.blocks[] | select(.isActive == true)' 2>/dev/null | head -n1)
    if [ -n "$active_block" ]; then
      cost_usd=$(echo "$active_block" | jq -r '.costUSD // empty')
      cost_per_hour=$(echo "$active_block" | jq -r '.burnRate.costPerHour // empty')
      tot_tokens=$(echo "$active_block" | jq -r '.totalTokens // empty')

      # Session time calculation
      reset_time_str=$(echo "$active_block" | jq -r '.usageLimitResetTime // .endTime // empty')
      start_time_str=$(echo "$active_block" | jq -r '.startTime // empty')
      
      if [ -n "$reset_time_str" ] && [ -n "$start_time_str" ]; then
        start_sec=$(to_epoch "$start_time_str"); end_sec=$(to_epoch "$reset_time_str"); now_sec=$(date +%s)
        total=$(( end_sec - start_sec )); (( total<1 )) && total=1
        elapsed=$(( now_sec - start_sec )); (( elapsed<0 ))&&elapsed=0; (( elapsed>total ))&&elapsed=$total
        session_pct=$(( elapsed * 100 / total ))
        remaining=$(( end_sec - now_sec )); (( remaining<0 )) && remaining=0
        rh=$(( remaining / 3600 )); rm=$(( (remaining % 3600) / 60 ))
        end_hm=$(fmt_time_hm "$end_sec")
        session_txt="$(printf '%dh %dm until reset at %s (%d%%)' "$rh" "$rm" "$end_hm" "$session_pct")"
        session_bar=$(progress_bar "$session_pct" 10)
      fi
    fi
  fi
fi

# ---- context usage calculation ----
#if command -v jq >/dev/null 2>&1; then
#  # Try ccusage statusline first (if available) - pass the input JSON
#  context_statusline=$(echo "$input" | timeout 3s npx ccusage@latest statusline --offline 2>/dev/null || echo "$input" | timeout 3s ccusage statusline --offline 2>/dev/null || echo "")
#
#  if [ -n "$context_statusline" ] && ! echo "$context_statusline" | grep -q "‚ùå\|Error\|error\|No input"; then
#    # Parse ccusage statusline output to extract context usage (üß† portion)
#    # Expected format: "ü§ñ Model | üí∞ costs | üî• rate | üß† context"
#    context_portion=$(echo "$context_statusline" | grep -o 'üß†[^|]*' | sed 's/üß† *//' | xargs)
#    if [ -n "$context_portion" ] && [ "$context_portion" != "N/A" ]; then
#      context_txt="$context_portion"
#      # Extract percentage if available for color coding
#      if echo "$context_portion" | grep -q '%'; then
#        context_pct=$(echo "$context_portion" | grep -o '[0-9]\+%' | sed 's/%//')
#        if [[ "$context_pct" =~ ^[0-9]+$ ]]; then
#          context_bar=$(progress_bar "$context_pct" 10)
#        fi
#      fi
#    fi
#  fi
#
#  # Fallback: estimate context usage from session data if ccusage didn't provide useful data
#  if [ -z "$context_txt" ]; then
#    # Approximate context limit for Claude models (adjust as needed)
#    model_context_limit=200000  # 200k tokens as common limit
#
#    if [ -n "$tot_tokens" ] && [[ "$tot_tokens" =~ ^[0-9]+$ ]]; then
#      # Estimate current context usage
#      # Since we don't have real conversation tracking, make a reasonable estimate
#      # For very large sessions, assume we're using a significant portion but not all
#      if [ "$tot_tokens" -gt "$model_context_limit" ]; then
#        # For large sessions, estimate 60-80% context usage
#        estimated_context=$(( model_context_limit * 3 / 4 ))  # 75% of limit
#      elif [ "$tot_tokens" -gt $(( model_context_limit / 2 )) ]; then
#        # For medium sessions, estimate proportional usage
#        estimated_context=$(( tot_tokens * 2 / 3 ))
#      else
#        # For smaller sessions, use actual token count as approximation
#        estimated_context=$tot_tokens
#      fi
#
#      context_pct=$(( estimated_context * 100 / model_context_limit ))
#      context_bar=$(progress_bar "$context_pct" 10)
#      context_txt="$(printf '%dk/%dk (%d%%)' $((estimated_context/1000)) $((model_context_limit/1000)) "$context_pct")"
#    fi
#  fi
#fi

# ---- render statusline ----
printf 'üìÅ %s%s%s' "$(dir_color)" "$current_dir" "$(rst)"
# git display
if [ -n "$git_branch" ]; then
  printf '  üåø %s%s%s' "$(git_color)" "$git_branch" "$(rst)"
fi
printf '  ü§ñ %s%s%s' "$(model_color)" "$model_name" "$(rst)"
if [ -n "$model_version" ] && [ "$model_version" != "null" ]; then
  printf '  üè∑Ô∏è %s%s%s' "$(version_color)" "$model_version" "$(rst)"
fi
# session time
if [ -n "$session_txt" ]; then
  printf '  ‚åõ %s%s%s' "$(session_color)" "$session_txt" "$(rst)"
  printf '  %s[%s]%s' "$(session_color)" "$session_bar" "$(rst)"
fi
# cost
if [ -n "$cost_usd" ] && [[ "$cost_usd" =~ ^[0-9.]+$ ]]; then
  if [ -n "$cost_per_hour" ] && [[ "$cost_per_hour" =~ ^[0-9.]+$ ]]; then
    printf '  üíµ %s$%.2f ($%.2f/h)%s' "$(cost_color)" "$cost_usd" "$cost_per_hour" "$(rst)"
  else
    printf '  üíµ %s$%.2f%s' "$(cost_color)" "$cost_usd" "$(rst)"
  fi
fi
# context usage progress bar
if [ -n "$context_txt" ]; then
  if [ -n "$context_bar" ]; then
    printf '  üß† %s%s%s %s[%s]%s' "$(context_color)" "$context_txt" "$(rst)" "$(context_color)" "$context_bar" "$(rst)"
  else
    printf '  üß† %s%s%s' "$(context_color)" "$context_txt" "$(rst)"
  fi
fi
